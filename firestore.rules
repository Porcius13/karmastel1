rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // USERS:
    // - Public Read (for "Featured Curators" and profile pages)
    // - Write Only by Owner (creating/updating profile)
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;

      // FOLLOWERS Subcollection:
      // Path: /users/{targetUserId}/followers/{followerUserId}
      match /followers/{followerId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == followerId;
      }

      // FOLLOWING Subcollection:
      // Path: /users/{currentUserId}/following/{targetUserId}
      match /following/{targetId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == userId;
      }

      // NOTIFICATIONS Subcollection:
      // Path: /users/{userId}/notifications/{notificationId}
      match /notifications/{notificationId} {
        // Owner can read, update (mark as read), delete
        allow read, update, delete: if request.auth != null && request.auth.uid == userId;
        // Anyone (authenticated) can create a notification for this user (e.g. "User A followed you")
        allow create: if request.auth != null;
      }

      // SAVED COLLECTIONS Subcollection:
      // Path: /users/{userId}/saved_collections/{docId}
      match /saved_collections/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // COLLECTION SETTINGS:
    // - Read: Allow if public OR if owner
    // - Write: Only by Owner
    match /collection_settings/{docId} {
      // Allow list queries if they filter by isPublic==true is implicit in secure queries,
      // but 'allow read' covers get & list.
      // We allow list simply if true to enable the query, relying on the filter.
      allow read: if resource.data.isPublic == true || (request.auth != null && resource.data.userId == request.auth.uid);
      
      // Explicit write permissions
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;

      // LIKES Subcollection:
      // Path: collection_settings/{collectionId}/likes/{userId}
      match /likes/{userId} {
        allow read: if true;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // PRODUCTS:
    // - Read: Public
    // - Write: Only by Owner
    match /products/{productId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}
